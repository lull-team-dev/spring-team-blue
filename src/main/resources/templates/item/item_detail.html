<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
<title th:text="'商品詳細 - ' + ${item.name}">商品詳細ページ</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body class="pt-[100px] bg-[var(--main-bg-color)]">
  <div th:replace="fragments/header_user :: header"></div>

  <main class="min-h-screen py-10 font-serifjp ">
    <div class="max-w-5xl mx-auto fade-in-up   p-6 flex  mt-25  gap-6">
      <!-- 商品画像 -->
      <div class="flex-shrink-0 overflow-hidden  relative">
      <div
        th:if="${item.soldOut}"
        class="absolute   -left-25 top-18 w-[400px] text-center bg-red-600 text-white text-4xl font-bold py-3 rotate-[-45deg] shadow-md z-10"
      >
        SOLDOUT
        </div>
        <div>
          <!-- 画像あり -->
   
             <img
            th:if="${item.image != null}"
            th:src="@{'/images/items/' + ${item.image}}"
            alt="商品画像"
            class="max-w-[400px] rounded-[33px] aspect-[3/3] object-fill h-auto "
          />

        </div>
        
        <p class="text-center text-xl text-[#6b4e35] font-bold mt-4">
          ¥<span th:text="${item.price}"></span>
        </p>
      </div>
<!-- 商品情報 -->
<div class="flex-1  flex flex-col justify-between p-6 rounded-[30px] bg-[#ffffff] shadow-[0_0_8px_rgba(221,179,142,0.5)] border border-[#eddccc] space-y-4">

  <!-- 投稿者とリンク -->
  <div class="flex justify-between  items-start">
    <p class="text-sm">投稿者：<span th:text="${item.account.nickname}"></span></p>
    <div>
      <a th:if="${@myAccount.id != item.account.id}" th:href="@{/mypage/user/{id}/detail(id=${item.account.id})}" class="text-sm text-blue-600 hover:underline">
        出品者プロフィールを見る→
      </a>
      <a th:if="${@myAccount.id == item.account.id}" th:href="@{/mypage}" class="text-sm text-blue-600 hover:underline">
        マイページ
      </a>
    </div>
  </div>

  <!-- 区切り線 -->
  <div class="w-full h-[1px] bg-[#e7d8c6]"></div>

  <!-- 商品名と紹介 -->
  <div class="grow space-y-3">
    <p class="text-xl font-semibold text-center"><span th:text="${item.name}"></span></p>
    <p class="whitespace-pre-wrap">商品紹介：<br>
    <span class="block text-left" th:text="${#strings.trim(item.memo)}"></span></p>
  </div>

  <!-- 区切り線 -->
  <div class="w-full h-[1px] bg-[#e7d8c6]"></div>

  <!-- ボタン -->
  <div class="flex gap-4 mx-auto">
    <th:block th:if="${@myAccount.id != item.account.id}">
      <form th:action="@{/order/{itemId}(itemId=${item.id})}" method="get">
        <button
          th:disabled="${item.soldOut}"
          th:title="${item.soldOut ? '売り切れのため購入できません' : ''}"
          class="px-6 py-2 rounded-full text-white primary-button font-semibold transition-colors"
          th:classappend="${item.soldOut} ? ' bg-gray-400 cursor-not-allowed' : ' bg-pink-400 hover:bg-red-500'">
          <span th:text="${item.soldOut ? '売り切れ' : '購入する'}"></span>
        </button>
      </form>
      <form th:action="@{/chat}" method="post">
        <input type="hidden" name="itemId" th:value="${item.id}">
        <input type="hidden" name="ownerId" th:value="${item.account.id}">
        <button
          class="px-6 py-2 rounded-full primary-button font-semibold ">
          チャットを始める
        </button>
      </form>
    </th:block>

    <th:block th:if="${@myAccount.id != item.account.id}">
    

        <!-- お気に入りボタン -->
        <button
          class=" text-2xl bookmark-btn"
          th:attr="data-item-id=${item.id}"
          aria-label="お気に入りに追加または解除"
        >
          <span
            class="text-red-500"
            th:if="${bookmarkedItemIds != null and #lists.contains(bookmarkedItemIds, item.id)}"
            >♥</span
          >
          <span
            th:if="${bookmarkedItemIds == null or !#lists.contains(bookmarkedItemIds, item.id)}"
            >♡</span
          >
        </button>

  </th:block>

    <th:block th:if="${@myAccount.id == item.account.id}">
      <a th:href="@{'/items/' + ${item.id} + '/edit'}" class="text-sm primary-button hover:underline">編集する</a>

    </th:block>
  </div>

</div>
    </div>

    <div class="mt-8 text-center">
      <a href="/" class="text-xl font-bold  ">← 一覧へ</a>
    </div>
  </main>


  <div th:replace="fragments/footer :: footer"></div>


      <!-- お気に入り切り替えスクリプト -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".bookmark-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const itemId = btn.getAttribute("data-item-id");
            const response = await fetch("/bookmarks/toggle-ajax", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `itemId=${itemId}`,
            });
            btn.disabled = true;
            const result = await response.text();
            btn.disabled = false;
            if (result === "unauthenticated") {
              alert("お気に入り機能を利用するには、ログインしてください");
              return;
            }
            const iconSpan = btn.querySelector("span");
            if (result === "bookmarked") {
              iconSpan.textContent = "♥";
              iconSpan.classList.add("text-red-500");
            } else {
              iconSpan.textContent = "♡";
              iconSpan.classList.remove("text-red-500");
            }
          });
        });
      });
    </script>

    <script th:src="@{/js/scroll-animate.js}"></script>

</body>

</html>