<!-- templates/bookmark/bookmark_list.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <title>お気に入り一覧</title>
</head>

<body>

  <div>
    <h2>お気に入り一覧</h2>

    <div class="item-link">
      <!-- お気に入りが空の場合の表示 -->
      <div th:if="${bookmarks.isEmpty()}">
        <p>お気に入りに登録された商品はありません。</p>
      </div>

      <!-- お気に入りの商品を一覧で表示 -->
      <div th:each="bookmark : ${bookmarks}">
        <div style="margin-bottom: 20px;">
          <a th:href="@{'/items/' + ${bookmark.item.id} + '/detail'}">
            <img th:if="${bookmark.item.image != null}"
                 th:src="@{'/images/items/' + ${bookmark.item.image}}"
                 alt="商品画像" width="200">
          </a>
          <p th:text="${bookmark.item.name}">商品名</p>
          <p th:text="${bookmark.item.price + '円'}">価格</p>

          <!-- お気に入り解除ボタン（Ajax連携用） -->
          <button class="bookmark-remove-btn"
                  th:attr="data-item-id=${bookmark.item.id}">
            ♥ お気に入り解除
          </button>
        </div>
      </div>
	  
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.bookmark-remove-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const itemId = btn.getAttribute('data-item-id');

          // Ajaxでブックマーク解除リクエストを送信
          const response = await fetch('/bookmarks/toggle-ajax', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `itemId=${itemId}`
          });

          const result = await response.text();

          if (result === 'unauthenticated') {
            alert('ログインしてください');
            return;
          }

          // 解除に成功したら、その商品ブロックをDOMから削除
          const itemBlock = btn.closest('div[style]');
          itemBlock.remove();

          // お気に入りが全て解除されて空になったらメッセージを表示
          const container = document.querySelector('.item-link');
          if (container.children.length === 1) {
            container.innerHTML = '<p>お気に入りに登録された商品はありません。</p>';
          }
        });
      });
    });
  </script>
</body>

</html>